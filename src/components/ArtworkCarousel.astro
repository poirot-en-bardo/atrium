---
import ArtworkCard from './ArtworkCard.astro';

interface Artwork {
  id: string;
  title: string;
  author: string;
  imageUrl: string;
  year?: string;
  description?: string;
  price?: number;
  sold?: boolean;
  forSale?: boolean;
}

interface Props {
  artworks: Artwork[];
}

const { artworks } = Astro.props;
const hasMultiple = artworks.length > 1;
---

<div
  class={`artwork-carousel ${hasMultiple ? '' : 'artwork-carousel-single'}`}
  role="region"
  aria-label="Artwork carousel"
  data-carousel={hasMultiple ? '' : undefined}
>
  <div class="artwork-track" tabindex="0" data-carousel-track>
    {artworks.map((art) => (
      <div class="artwork-slide">
        <ArtworkCard {...art} />
      </div>
    ))}
  </div>
  {hasMultiple && (
    <>
      <div class="carousel-arrows">
        <button class="carousel-arrow left" type="button" aria-label="Anterior">‹</button>
        <button class="carousel-arrow right" type="button" aria-label="Urmator">›</button>
      </div>
      <div class="carousel-dots" aria-hidden="true">
        {artworks.map((_, index) => (
          <span class="carousel-dot" data-carousel-dot={index}></span>
        ))}
      </div>
    </>
  )}
</div>

<script>
  const carousels = document.querySelectorAll('[data-carousel]');
  carousels.forEach((carousel) => {
    const track = carousel.querySelector('[data-carousel-track]');
    const dots = Array.from(carousel.querySelectorAll('[data-carousel-dot]'));
    const prevButton = carousel.querySelector('.carousel-arrow.left');
    const nextButton = carousel.querySelector('.carousel-arrow.right');
    if (!track || dots.length === 0) return;

    const updateDots = () => {
      const slides = Array.from(track.children);
      if (slides.length === 0) return;
      const trackRect = track.getBoundingClientRect();
      let activeIndex = 0;
      let minDistance = Infinity;
      slides.forEach((slide, index) => {
        const rect = slide.getBoundingClientRect();
        const distance = Math.abs(rect.left - trackRect.left);
        if (distance < minDistance) {
          minDistance = distance;
          activeIndex = index;
        }
      });
      dots.forEach((dot, index) => {
        dot.classList.toggle('is-active', index === activeIndex);
      });
    };

    updateDots();
    track.addEventListener('scroll', updateDots, { passive: true });
    window.addEventListener('resize', updateDots);

    const scrollByPage = (direction) => {
      track.scrollBy({ left: direction * track.clientWidth, behavior: 'smooth' });
    };

    prevButton?.addEventListener('click', () => scrollByPage(-1));
    nextButton?.addEventListener('click', () => scrollByPage(1));
  });
</script>
